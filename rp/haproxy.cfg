# HAProxy Configuration File: Conditional Path Routing

global
    log 127.0.0.1 local0 notice
    maxconn 2000
    chroot /var/lib/haproxy
    user haproxy
    group haproxy
    daemon
    stats socket /var/run/haproxy.sock mode 660 level admin expose-fd listeners

# Default settings for all sections

defaults
    log global
    mode http
    option httplog
    option dontlognull
    option http-server-close
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms
    # Using default error files from the HAProxy container image
    errorfile 400 /usr/local/etc/haproxy/errors/400.http
    errorfile 403 /usr/local/etc/haproxy/errors/403.http
    errorfile 408 /usr/local/etc/haproxy/errors/408.http
    errorfile 500 /usr/local/etc/haproxy/errors/500.http
    errorfile 502 /usr/local/etc/haproxy/errors/502.http
    errorfile 503 /usr/local/etc/haproxy/errors/503.http
    errorfile 504 /usr/local/etc/haproxy/errors/504.http

# Frontend section for handling incoming web traffic on port 80

frontend http_in
    bind *:80
    mode http

    # ACL 1: Define requests where the path is exactly '/'
    acl is_root path -i /

    # Conditional Routing Rule: Send to the dedicated root backend if the ACL matches
    use_backend root_host if is_root

    # Default Rule: If the path is anything else (e.g., /api, /images, /login), send to the main web servers
    default_backend web_servers


# Backend 1: Dedicated server for the root path

backend root_host
    balance roundrobin
    # Using Docker Service Name (Hostname) instead of IP
    server root_server root-app:80 check

# Backend 2: Load-balanced pool for all other requests

backend web_servers
    balance roundrobin
    # Using Docker Service Names (Hostnames) instead of IPs
    server web1 main-app-1:8080 check
    server web2 main-app-2:8080 check

# Optional: Stats/Monitoring Interface

listen stats
    bind *:8080
    stats enable
    stats uri /haproxy_stats
    stats auth admin:password123
    stats refresh 5s